<!-- DIRECT CHAT -->
<div class="card direct-chat direct-chat-primary">
  <div class="card-header">
    <h3 class="card-title">Direct Chat</h3>

    <div class="card-tools">
      <span title="3 New Messages" class="badge badge-primary">3</span>
      <button type="button" class="btn btn-tool" data-card-widget="collapse">
        <i class="fas fa-minus"></i>
      </button>
      <button
        type="button"
        class="btn btn-tool"
        title="Contacts"
        data-widget="chat-pane-toggle"
      >
        <i class="fas fa-comments"></i>
      </button>
      <button type="button" class="btn btn-tool" data-card-widget="remove">
        <i class="fas fa-times"></i>
      </button>
    </div>
  </div>
  <!-- /.card-header -->
  <div class="card-body">
    <!-- Conversations are loaded here -->
    <div class="direct-chat-messages" id="chat_window"></div>
    <!--/.direct-chat-messages-->

    <!-- Contacts are loaded here -->
    <div class="direct-chat-contacts">
      <ul class="contacts-list">
        <li>
          <a href="#">
            <img
              class="contacts-list-img"
              href="static/dist/img/user1-128x128.jpg"
              alt="User Avatar"
            />

            <!-- /.contacts-list-info -->
          </a>
        </li>
        <!-- End Contact Item -->
        <li>
          <a href="#">
            <img
              class="contacts-list-img"
              href="static/dist/img/user7-128x128.jpg"
              alt="User Avatar"
            />

            <!-- /.contacts-list-info -->
          </a>
        </li>
        <!-- End Contact Item -->
        <li>
          <a href="#">
            <img
              class="contacts-list-img"
              href="static/dist/img/user3-128x128.jpg"
              alt="User Avatar"
            />

            <!-- /.contacts-list-info -->
          </a>
        </li>
        <!-- End Contact Item -->
        <li>
          <a href="#">
            <img
              class="contacts-list-img"
              href="static/dist/img/user5-128x128.jpg"
              alt="User Avatar"
            />

            <!-- /.contacts-list-info -->
          </a>
        </li>
        <!-- End Contact Item -->
        <li>
          <a href="#">
            <img
              class="contacts-list-img"
              href="static/dist/img/user6-128x128.jpg"
              alt="User Avatar"
            />

            <!-- /.contacts-list-info -->
          </a>
        </li>
        <!-- End Contact Item -->
        <li>
          <a href="#">
            <img
              class="contacts-list-img"
              href="static/dist/img/user8-128x128.jpg"
              alt="User Avatar"
            />

            <!-- /.contacts-list-info -->
          </a>
        </li>
        <!-- End Contact Item -->
      </ul>
      <!-- /.contacts-list -->
    </div>
    <!-- /.direct-chat-pane -->
  </div>
  <!-- /.card-body -->
  <!-- 채팅 메시지를 입력하는 파트 -->
  <div class="card-footer">
    <!-- <form action="#" method="post"> -->
    <div class="input-group">
      <input
        type="text"
        name="message"
        placeholder="Type Message ..."
        class="form-control"
      />
      <span class="input-group-append">
        <button type="button" class="btn btn-primary" id="btn-chat">
          전송
        </button>
      </span>
    </div>
    <!-- </form> -->
  </div>
  <!-- /.card-footer-->
</div>
<!--/.direct-chat -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.7.3/socket.io.min.js"></script>
<script>
  let str = "http://" + document.domain + ":" + location.port;

  let socket = io.connect(str);
  let user_name = "";

  socket.on("connect", () => {
    user_name = prompt("닉네임을 입력하세요");
    console.log(user_name);
    socket.emit("c_send_userName", { name: user_name });
  });
  socket.on("s_send_msg", (data) => {
    sender = data.user;
    msg = data.msg;
    console.log(sender, msg);
    chatMsgShow(sender, msg, user_name === sender ? true : false);
  });

  function chatMsgShow(sender, msg, isRight) {
    let time = new Date();
    let msgHtml = "";
    if (isRight) {
      msgHtml = `
                <div class="direct-chat-msg right">
                    <div class="direct-chat-infos clearfix">
                        <span class="direct-chat-name float-right">${sender}</span>
                        <span class="direct-chat-timestamp float-left">${time}</span>
                    </div>
                    <!-- /.direct-chat-infos -->
                    <img class="direct-chat-img" src="static/dist/img/user3-128x128.jpg"
                        alt="message user image">
                    <!-- /.direct-chat-img -->
                    <div class="direct-chat-text">
                        ${msg}
                    </div>
                    <!-- /.direct-chat-text -->
                </div>
            `;
    else {
      msgHtml = `
                <div class="direct-chat-msg">
                    <div class="direct-chat-infos clearfix">
                        <span class="direct-chat-name float-left">${sender}</span>
                        <span class="direct-chat-timestamp float-right">${time}</span>
                    </div>
                    <!-- /.direct-chat-infos -->
                    <img class="direct-chat-img" src="static/dist/img/user1-128x128.jpg"
                        alt="message user image">
                    <!-- /.direct-chat-img -->
                    <div class="direct-chat-text">
                        ${msg}
                    </div>
                    <!-- /.direct-chat-text -->
                </div>
            `;
    }

    $("#chat_window")
      .append(msgHtml)
      .stop()
      .animate(
        {
          scrollTop: $("#chat_window")[0].scrollHeight,
        },
        1000
      );
  }

  $("[name=message]").on("keypress", (evt) => {
    //console.log( evt.key, evt.keyCode )
    if (evt.keyCode == 13) {
      sendMsg(socket);
    }
  });


  $("#btn-chat").on("click", (evt) => {
    //console.log('클릭')
    sendMsg(socket);
  });

  function sendMsg(socket) {

    const msg = $("[name=message]").val().trim();
    if (msg === "" || msg === undefined || msg === null) {
      alert("메시지를 입력하고 전송하세요");
      return;
    }
    socket.emit("c_send_msg", { user: user_name, msg: msg });
    $("[name=message]").val("");
  }
</script>
